---
title: "article_figures2"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{article_figures}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(WWdPCR)
library(ggplot2)
```

# Load and check data

Data is stored as .rda and has been loaded when attaching the package.

```{r}
str(dPCR_HV6970del)
str(dPCR_Orf1adel)
str(clinical_HV6970del)
str(clinical_ORF1adel)
```

```{r}
dPCRdat <- read.csv("DATA_TimeSeries_RAnalysis_4_TN.csv")
dPCRdat$date <- as.Date(dPCRdat$date, format="%d.%m.%y")
dPCRdat$dayssince <- as.numeric(dPCRdat$date - as.Date("07.12.20", format="%d.%m.%y"))


dPCRdat_hv6970 <- dPCRdat[dPCRdat$Assay == "del6970", ]
dPCRdat_hv6970 <- dPCRdat_hv6970[!is.na(dPCRdat_hv6970$date), ]
dPCRdat_hv6970$x0 <- dPCRdat_hv6970$WTpos_NumberOfNegativeDroplets
dPCRdat_hv6970$x1 <- dPCRdat_hv6970$VarPos._NumberOfPositiveDroplets
dPCRdat_hv6970$x2 <- dPCRdat_hv6970$WTpos_NumberOfPositiveDroplets
dPCRdat_hv6970$frac_var <- with(dPCRdat_hv6970, (log(x0/(x0+x1))/log(x0/(x0+x1+x2))))

# plot(dPCRdat_hv6970$date, dPCRdat_hv6970$frac_var)


dPCRdat_orf1a <- dPCRdat[dPCRdat$Assay == "orf1a", ]
dPCRdat_orf1a <- dPCRdat_orf1a[!is.na(dPCRdat_orf1a$date), ]
dPCRdat_orf1a$x0 <- dPCRdat_orf1a$WTpos_NumberOfNegativeDroplets
dPCRdat_orf1a$x1 <- dPCRdat_orf1a$VarPos._NumberOfPositiveDroplets
dPCRdat_orf1a$x2 <- dPCRdat_orf1a$WTpos_NumberOfPositiveDroplets
dPCRdat_orf1a$frac_var <- with(dPCRdat_orf1a, (log(x0/(x0+x1))/log(x0/(x0+x1+x2))))

# plot(dPCRdat_orf1a$date, dPCRdat_orf1a$frac_var)

dPCR_HV6970del <- dPCRdat_hv6970[,c("x0", "x1", "x2", "date", "dayssince", "frac_var", "Dilutionfactor")]
dPCR_Orf1adel <- dPCRdat_orf1a[,c("x0", "x1", "x2", "date", "dayssince", "frac_var", "Dilutionfactor")]
```


# Fit models on dPCR WWTP data

## Fit 3PL on wastewater data

### Fit on HV69-70del

```{r}
dPCR_HV6970del_3PL <- fit_pl(dPCR_HV6970del[,1:3], dPCR_HV6970del$dayssince,
                             likelihood = loglik_trinom_prof,
                             quasi=TRUE,
                             starting_values = c("a"=0.08, "b"=67, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
knitr::kable(confint(dPCR_HV6970del_3PL))
```

### Fit on Orf1a

```{r}
dPCR_Orf1a_3PL <- fit_pl(dPCR_Orf1adel[,1:3], dPCR_Orf1adel$dayssince,
                             likelihood = loglik_trinom_prof,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=67, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
knitr::kable(confint(dPCR_Orf1a_3PL))
```

## Fit 2PL on wastewater data

### Fit on HV69-70del

```{r}
dPCR_HV6970del_2PL <- fit_pl(dPCR_HV6970del[,1:3], dPCR_HV6970del$dayssince,
                             likelihood = loglik_trinom_prof,
                             fitfun = pl2model,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=67),
                             lower=c(0, -Inf), upper=c(1, Inf))
knitr::kable(confint(dPCR_HV6970del_2PL))
```

### Fit on Orf1a

```{r}
dPCR_Orf1a_2PL <- fit_pl(dPCR_Orf1adel[,1:3], dPCR_Orf1adel$dayssince,
                             likelihood = loglik_trinom_prof,
                             fitfun = pl2model,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=67),
                             lower=c(0, -Inf), upper=c(1, Inf))
knitr::kable(confint(dPCR_Orf1a_2PL))
```

## Quasi likelihood ratio tests

Using largest inflation factor 

```{r}
# compute quasi log-likelihood ratio, with inflation factor from 2PL (more conservative)
dPCR_HV6970_llr <- -2*((-1*dPCR_HV6970del_3PL$likelihood/dPCR_HV6970del_2PL$infl_factor) - (-1*dPCR_HV6970del_3PL$likelihood/dPCR_HV6970del_3PL$infl_factor))
# chisquare test of the log-likelihood ratio
knitr::kable(data.frame("2logLr:"=dPCR_HV6970_llr, "p-val:"=formatC(1-pchisq(dPCR_HV6970_llr, 1), format = "e", digits = 2)))
```

```{r}
# compute quasi log-likelihood ratio, with inflation factor from 2PL (more conservative)
dPCR_Orf1a_llr <- -2*((-1*dPCR_Orf1a_3PL$likelihood/dPCR_Orf1a_2PL$infl_factor) - (-1*dPCR_Orf1a_2PL$likelihood/dPCR_Orf1a_2PL$infl_factor))
# chisquare test of the log-likelihood ratio
knitr::kable(data.frame("2logLr:"=dPCR_Orf1a_llr, "p-val:"=formatC(1-pchisq(dPCR_Orf1a_llr, 1), format = "e", digits = 2)))
```



# Fit models on clinical data

## Fit 3PL on clinical data

### Fit on HV69-70del

```{r}
clinical_HV6970del <- clinical_HV6970del[(as.Date(clinical_HV6970del$date) >= as.Date("2020-12-07")) & 
                                           (as.Date(clinical_HV6970del$date) <= as.Date("2021-03-26")), ]

clinical_HV6970del_3PL <- fit_pl(clinical_HV6970del$HV69.70del/clinical_HV6970del$sequenced,
                             as.numeric(as.Date(clinical_HV6970del$date)-as.Date("2020-12-07")),
                             clinical_HV6970del$sequenced,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=67, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
knitr::kable(confint(clinical_HV6970del_3PL))
```


### Fit on Orf1a

```{r}
clinical_ORF1adel <- clinical_ORF1adel[(as.Date(clinical_ORF1adel$date) >= as.Date("2020-12-07")) & 
                                           (as.Date(clinical_ORF1adel$date) <= as.Date("2021-03-26")), ]
clinical_ORF1a_3PL <- fit_pl(clinical_ORF1adel$ORF1adel/clinical_ORF1adel$sequenced,
                             as.numeric(as.Date(clinical_ORF1adel$date)-as.Date("2020-12-07")),
                             clinical_ORF1adel$sequenced,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=67, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
knitr::kable(confint(clinical_ORF1a_3PL))
```

## Fit 2PL on clinical data

### Fit on HV69-70del

```{r}
clinical_HV6970del_2PL <- fit_pl(clinical_HV6970del$HV69.70del/clinical_HV6970del$sequenced,
                             as.numeric(as.Date(clinical_HV6970del$date)-as.Date("2020-12-07")),
                             clinical_HV6970del$sequenced,
                             fitfun = pl2model,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=67),
                             lower=c(0, -Inf), upper=c(1, Inf))
knitr::kable(confint(clinical_HV6970del_2PL))
```

### Fit on Orf1a

```{r}
clinical_ORF1a_2PL <- fit_pl(clinical_ORF1adel$ORF1adel/clinical_ORF1adel$sequenced,
                             as.numeric(as.Date(clinical_ORF1adel$date)-as.Date("2020-12-07")),
                             clinical_ORF1adel$sequenced,
                             fitfun = pl2model,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=67),
                             lower=c(0, -Inf), upper=c(1, Inf))
knitr::kable(confint(clinical_ORF1a_2PL))
```


### Fit all

```{r}
clinical_data_tot <- aggregate(. ~ date, data=clinical_data, sum)
clinical_data_tot <- clinical_data_tot[(as.Date(clinical_data_tot$date) >= as.Date("2020-12-07")) & 
                                           (as.Date(clinical_data_tot$date) <= as.Date("2021-03-26")), ]

clinical_data_ZH <- clinical_data[clinical_data$division == "Zurich",]
clinical_data_ZH <- clinical_data_ZH[(as.Date(clinical_data_ZH$date) >= as.Date("2020-12-07")) & 
                                           (as.Date(clinical_data_ZH$date) <= as.Date("2021-03-26")), ]

clinical_models <- list()
clinical_models$Switzerland <- lapply(c("HV6970del", "ORF1adel", "B117"), function(i){
  fit_3pl <- fit_pl(clinical_data_tot[, i] /clinical_data_tot$Tot,
                             as.numeric(as.Date(clinical_data_tot$date)-as.Date("2020-12-07")),
                             clinical_data_tot$Tot,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=67, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
  
  fit_2pl <- fit_pl(clinical_data_tot[, i]/clinical_data_tot$Tot,
                             as.numeric(as.Date(clinical_data_tot$date)-as.Date("2020-12-07")),
                             clinical_data_tot$Tot,
                             fitfun = pl2model,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=60),
                             lower=c(0, -Inf), upper=c(1, Inf))
  out <- list(fit_3pl = fit_3pl, fit_2pl = fit_2pl)
  out
})
names(clinical_models$Switzerland) <- c("HV6970del", "ORF1adel", "B117")

clinical_models$Zurich <- lapply(c("HV6970del", "ORF1adel", "B117"), function(i){
  fit_3pl <- fit_pl(clinical_data_ZH[, i] /clinical_data_ZH$Tot,
                             as.numeric(as.Date(clinical_data_ZH$date)-as.Date("2020-12-07")),
                             clinical_data_ZH$Tot,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=65, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
  
  fit_2pl <- fit_pl(clinical_data_ZH[, i]/clinical_data_ZH$Tot,
                             as.numeric(as.Date(clinical_data_ZH$date)-as.Date("2020-12-07")),
                             clinical_data_ZH$Tot,
                             fitfun = pl2model,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=65),
                             lower=c(0, -Inf), upper=c(1, Inf))
  out <- list(fit_3pl = fit_3pl, fit_2pl = fit_2pl)
  out
})
names(clinical_models$Zurich) <- c("HV6970del", "ORF1adel", "B117")

coef(clinical_models$Switzerland$HV6970del$fit_3pl)

lapply(clinical_models, function(i){
  lapply(i, function(j){
    lapply(j, function(k){
     knitr::kable(confint(k))
    })
  })
})


```

```{r}
t1 <- confint(clinical_models$Zurich$HV6970del$fit_3pl)
t1 <- rbind.data.frame(t1, t(data.frame("a2"=exp(4.8*t1["a",])) -1))
t2 <- round(t1, 2)
ests <- paste0(t2$estimate, " [",t2$lower, ", ", t2$upper, "]")
data.frame("bla"=ests)

coefs_df <- lapply(names(clinical_models), function(i, n1){
  out_j <- lapply(names(clinical_models[[i]]), function(j){
    out_k <- lapply(names(clinical_models[[i]][[j]]), function(k){
      mod = clinical_models[[i]][[j]][[k]]
      t1 <- confint(mod)
      t1 <- rbind.data.frame(t1, t(data.frame("a2"=exp(4.8*t1["a",])) -1))
      t2 <- round(t1, 2)
      ests <- paste0(t2$estimate, " [",t2$lower, ", ", t2$upper, "]")
      if(length(ests)==3){
        ests <- c(ests[1:2], "0 (fixed)", ests[3])
      }
      ests <- c(paste(i,j,k), ests)
      # return( data.frame(paste(i,j,k, sep = ".") = ests) )
      return(ests)
    })
    names(out_k) <- names(clinical_models[[i]][[j]])
    return(out_k)
  })
  names(out_j) <- names(clinical_models[[i]])
  return(out_j)
})
names(coefs_df) <- names(clinical_models)
coefs_df <- t(data.frame(unlist(unlist(coefs_df, recursive = FALSE), recursive = FALSE)))


coefs_df2 <- lapply(list(dPCR_HV6970del_3PL, dPCR_HV6970del_2PL, dPCR_Orf1a_3PL, dPCR_Orf1a_2PL), function(mod){
  t1 <- confint(mod)
  t1 <- rbind.data.frame(t1, t(data.frame("a2"=exp(4.8*t1["a",])) -1))
  t2 <- round(t1, 2)
  ests <- paste0(t2$estimate, " [",t2$lower, ", ", t2$upper, "]")
  if(length(ests)==3){
        ests <- c(ests[1:2], "0 (fixed)", ests[3])
  }
  return(ests)
})
coefs_df2 <- Reduce(function(...) rbind(...), coefs_df2)
coefs_df2 <- cbind(c("wastewater HV6970del fit_3PL", "wastewater HV6970del fit_2PL",
                     "wastewater ORF1adel fit_3PL", "wastewater ORF1adel fit_2PL"),
                   coefs_df2 )

coefs_dfs_out <- rbind(coefs_df2, coefs_df)
coefs_dfs_out[,1] <- gsub("fit_", "", coefs_dfs_out[,1])
coefs_dfs_out[,1] <- gsub("del", "", coefs_dfs_out[,1])
coefs_dfs_out[,1] <- gsub("pl", "PL", coefs_dfs_out[,1])


knitr::kable(coefs_dfs_out, row.names = FALSE)


```


### Quasi log-likelihood ratio tests

```{r}
lapply(clinical_models, function(i){
  lapply(i, function(j){
    llr <- -2*((-1*j$fit_3pl$likelihood / j$fit_2pl$infl_factor) - (-1*j$fit_2pl$likelihood/j$fit_2pl$infl_factor))
    knitr::kable(data.frame("2logLr:"=llr, "p-val:"=formatC(1-pchisq(llr, 1), format = "e", digits = 2)))
  })
})

```

## Quasi likelihood ratio tests

Using largest inflation factor 

```{r}
# compute quasi log-likelihood ratio, with inflation factor from 2PL (more conservative)
clinical_HV6970_llr <- -2*((-1*clinical_HV6970del_3PL$likelihood/clinical_HV6970del_2PL$infl_factor) - (-1*clinical_HV6970del_2PL$likelihood/clinical_HV6970del_2PL$infl_factor))
# chisquare test of the log-likelihood ratio
knitr::kable(data.frame("2logLr:"=clinical_HV6970_llr, "p-val:"=formatC(1-pchisq(clinical_HV6970_llr, 1), format = "e", digits = 2)))
```

```{r}
# compute quasi log-likelihood ratio, with inflation factor from 2PL (more conservative)
clinical_ORF1a_llr <- -2*((-1*clinical_ORF1a_3PL$likelihood/clinical_ORF1a_2PL$infl_factor) - (-1*clinical_ORF1a_2PL$likelihood/clinical_ORF1a_2PL$infl_factor))
# chisquare test of the log-likelihood ratio
knitr::kable(data.frame("2logLr:"=clinical_ORF1a_llr, "p-val:"=formatC(1-pchisq(clinical_ORF1a_llr, 1), format = "e", digits = 2)))
```





# Plots

```{r, fig.dim=c(7, 5)}
dPCR_HV6970del_empirical_freqs <- log(dPCR_HV6970del[,1]/apply(dPCR_HV6970del[,1:2], 1, sum)) / log(dPCR_HV6970del[,1]/apply(dPCR_HV6970del[,1:3], 1, sum))

dPCR_Orf1a_empirical_freqs <- log((dPCR_Orf1adel[,1])/apply(dPCR_Orf1adel[,1:2], 1, sum)) / log(dPCR_Orf1adel[,1]/apply(dPCR_Orf1adel[,1:3], 1, sum))

ggplot() + 
  geom_point(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_empirical_freqs, color="dPCR HV69-70del")) +
  geom_line(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_3PL$fitted, color="dPCR HV69-70del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_HV6970del$date),
                  ymin=logist_confint.plt_fit(dPCR_HV6970del_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_HV6970del_3PL)$upper, fill="dPCR HV69-70del"), alpha=0.2) + 

  
  geom_point(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_empirical_freqs, color="dPCR Orf1a")) + 
  geom_line(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_2PL$fitted, color="dPCR Orf1a")) + 
  geom_ribbon(aes(x=as.Date(dPCR_Orf1adel$date),
                  ymin=logist_confint.plt_fit(dPCR_Orf1a_2PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_Orf1a_2PL)$upper, fill="dPCR Orf1a"), alpha=0.2) + 
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) +
  theme_light() + 
  theme(legend.position="top")


```

## By mutations

### HV69-70del

```{r, fig.dim=c(7, 5)}
update_geom_defaults("point", list(size = 0.8))
points_alpha <- 0.8

plt1 <- ggplot() + 
  geom_point(aes(x=as.Date(clinical_HV6970del$date), y=clinical_HV6970del$HV69.70del/clinical_HV6970del$sequenced,
                 color="clinical HV69-70del"),
             alpha = points_alpha) + 
  geom_line(aes(x=as.Date(clinical_HV6970del$date), y=clinical_HV6970del_3PL$fitted, color="clinical HV69-70del")) + 
  geom_ribbon(aes(x=as.Date(clinical_HV6970del$date),
                  ymin=logist_confint.plt_fit(clinical_HV6970del_3PL)$lower,
                  ymax=logist_confint.plt_fit(clinical_HV6970del_3PL)$upper, fill="clinical HV69-70del"), alpha=0.2) + 
  
  geom_point(aes(x=clinical_models$Switzerland$B117$fit_2pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Switzerland$B117$fit_2pl$ydata,
                color="clinical B.1.1.7")) +
  geom_line(aes(x=clinical_models$Switzerland$B117$fit_2pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Switzerland$B117$fit_2pl$fitted,
                color="clinical B.1.1.7")) + 
  geom_ribbon(aes(x=clinical_models$Switzerland$B117$fit_2pl$xdata + as.Date("2020-12-07"),
                  ymin=logist_confint.plt_fit(clinical_models$Switzerland$B117$fit_2p)$lower,
                  ymax=logist_confint.plt_fit(clinical_models$Switzerland$B117$fit_2p)$upper, fill="clinical B.1.1.7"), alpha=0.2) + 
  
  geom_point(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_empirical_freqs, color="dPCR HV69-70del"),
             alpha = points_alpha) +
  geom_line(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_3PL$fitted, color="dPCR HV69-70del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_HV6970del$date),
                  ymin=logist_confint.plt_fit(dPCR_HV6970del_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_HV6970del_3PL)$upper, fill="dPCR HV69-70del"), alpha=0.2) + 
  
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) +
  theme_light() + 
  theme(legend.position="top") + 
  scale_colour_manual(
  values = c("steelblue", "red2", "orange"),
  breaks = c("dPCR HV69-70del", "clinical HV69-70del", "clinical B.1.1.7"),
  labels = c("wastewater HV69-70del", "clinical HV69-70del", "clinical B.1.1.7")
  ) + 
  scale_fill_manual(
  values = c("steelblue", "red2", "orange"),
  breaks = c("dPCR HV69-70del", "clinical HV69-70del", "clinical B.1.1.7"),
  labels = c("wastewater HV69-70del", "clinical HV69-70del", "clinical B.1.1.7")
  ) 


dPCR_HV6970del_agg <- aggregate(cbind(x0, x1, x2) ~ date + dayssince +Dilutionfactor,
                               data=dPCR_HV6970del, FUN=sum)
dPCR_HV6970del_agg <- dPCR_HV6970del_agg[,c("x0", "x1", "x2", "date", "dayssince", "Dilutionfactor")]
dPCR_HV6970del_agg$frac <- log((dPCR_HV6970del_agg[,1])/apply(dPCR_HV6970del_agg[,1:2], 1, sum)) /
  log(dPCR_HV6970del_agg[,1]/apply(dPCR_HV6970del_agg[,1:3], 1, sum))
dPCR_HV6970del_agg$concentration <- -log(dPCR_HV6970del_agg[,1]/apply(dPCR_HV6970del_agg[,1:3], 1, sum)) / 0.0005477004196028817 * 8 * dPCR_HV6970del_agg$Dilutionfactor
  


plt2 <- ggplot() + 
  geom_bar(aes(x=as.Date(dPCR_HV6970del_agg$date),
               y=dPCR_HV6970del_agg$concentration,
               fill="SARS-CoV-2"),
           stat="identity") + 
  geom_bar(aes(x=as.Date(dPCR_HV6970del_agg$date),
               y=dPCR_HV6970del_agg$concentration * dPCR_HV6970del_agg$frac,
               fill="dPCR HV6970 del"),
           stat="identity") + 
    xlab("date") + ylab("gc/ml") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("steelblue", "grey"),
  breaks = c("dPCR HV6970 del", "SARS-CoV-2"),
  labels = c("four", "six"))

plt3 <- ggplot() + 
  geom_bar(aes(x=clinical_models$Switzerland$HV6970del$fit_3pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Switzerland$HV6970del$fit_3pl$weights,
               fill="n"),
           stat="identity") + 
  geom_bar(aes(x=clinical_models$Switzerland$HV6970del$fit_3pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Switzerland$HV6970del$fit_3pl$weights * clinical_models$Switzerland$HV6970del$fit_3pl$ydata,
               fill="clinical HV6970 del"),
           stat="identity") + 
    xlab("date") + ylab("samples") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("red2", "grey"),
  breaks = c("clinical HV6970 del", "n"),
  labels = c("four", "six"))

plt4 <- ggplot() + 
  geom_bar(aes(x=clinical_models$Switzerland$B117$fit_2pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Switzerland$B117$fit_2pl$weights,
               fill="n"),
           stat="identity") + 
  geom_bar(aes(x=clinical_models$Switzerland$B117$fit_2pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Switzerland$B117$fit_2pl$weights * clinical_models$Switzerland$B117$fit_2pl$ydata,
               fill="clinical B117"),
           stat="identity") + 
    xlab("date") + ylab("samples") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("orange", "grey"),
  breaks = c("clinical B117", "n"),
  labels = c("four", "six")) +
  theme(legend.position = "none")

plt_HV <- ggpubr::ggarrange(plt1 + xlab(""),
                             plt2 + xlab(""),
                             plt3 + xlab(""),
                             plt4, heights = c(2.5,1,1,1),
                    ncol = 1, align = "v", labels = c("A","C","E","G"))
plt_HV

```

### ORF1a del

```{r, fig.dim=c(7, 5)}
points_alpha <- 0.8

plt1 <- ggplot() + 
  geom_point(aes(x=as.Date(clinical_ORF1adel$date), y=clinical_ORF1adel$ORF1adel/clinical_ORF1adel$sequenced,
                 color="clinical ORF1a del"),
             alpha = points_alpha) + 
  geom_line(aes(x=as.Date(clinical_ORF1adel$date), y=clinical_ORF1a_3PL$fitted, color="clinical ORF1a del")) + 
  geom_ribbon(aes(x=as.Date(clinical_ORF1adel$date),
                  ymin=logist_confint.plt_fit(clinical_ORF1a_3PL)$lower,
                  ymax=logist_confint.plt_fit(clinical_ORF1a_3PL)$upper, fill="clinical ORF1a del"), alpha=0.2) + 
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) +
  
    geom_point(aes(x=clinical_models$Switzerland$B117$fit_2pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Switzerland$B117$fit_2pl$ydata,
                color="clinical B.1.1.7")) +
  geom_line(aes(x=clinical_models$Switzerland$B117$fit_2pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Switzerland$B117$fit_2pl$fitted,
                color="clinical B.1.1.7")) + 
  geom_ribbon(aes(x=clinical_models$Switzerland$B117$fit_2pl$xdata + as.Date("2020-12-07"),
                  ymin=logist_confint.plt_fit(clinical_models$Switzerland$B117$fit_2p)$lower,
                  ymax=logist_confint.plt_fit(clinical_models$Switzerland$B117$fit_2p)$upper, fill="clinical B.1.1.7"), alpha=0.2) + 
  
  geom_point(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_empirical_freqs, color="dPCR ORF1a del"),
             alpha = points_alpha) +
  geom_line(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_3PL$fitted, color="dPCR ORF1a del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_Orf1adel$date),
                  ymin=logist_confint.plt_fit(dPCR_Orf1a_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_Orf1a_3PL)$upper, fill="dPCR ORF1a del"), alpha=0.2) + 

  theme_light() + 
  theme(legend.position="top") + 
  scale_colour_manual(
  values = c("steelblue", "red2", "orange"),
  breaks = c("dPCR ORF1a del", "clinical ORF1a del", "clinical B.1.1.7"),
  labels = c("wastewater ORF1a del", "clinical ORF1a del", "clinical B.1.1.7")
  ) + 
  scale_fill_manual(
  values = c("steelblue", "red2", "orange"),
  breaks = c("dPCR ORF1a del", "clinical ORF1a del", "clinical B.1.1.7"),
  labels = c("wastewater ORF1a del", "clinical ORF1a del", "clinical B.1.1.7")
  )

dPCR_Orf1adel_agg <- aggregate(cbind(x0, x1, x2) ~ date + dayssince +Dilutionfactor,
                               data=dPCR_Orf1adel, FUN=sum)
dPCR_Orf1adel_agg <- dPCR_Orf1adel_agg[,c("x0", "x1", "x2", "date", "dayssince", "Dilutionfactor")]
dPCR_Orf1adel_agg$frac <- log((dPCR_Orf1adel_agg[,1])/apply(dPCR_Orf1adel_agg[,1:2], 1, sum)) /
  log(dPCR_Orf1adel_agg[,1]/apply(dPCR_Orf1adel_agg[,1:3], 1, sum))
dPCR_Orf1adel_agg$concentration <- -log(dPCR_Orf1adel_agg[,1]/apply(dPCR_Orf1adel_agg[,1:3], 1, sum)) / 0.0005477004196028817 * 8 * dPCR_Orf1adel_agg$Dilutionfactor
  
plt2 <- ggplot() + 
  geom_bar(aes(x=as.Date(dPCR_Orf1adel_agg$date),
               y=dPCR_Orf1adel_agg$concentration,
               # fill="SARS-CoV-2"
               ),
           stat="identity",
           fill="grey") + 
  geom_bar(aes(x=as.Date(dPCR_Orf1adel_agg$date),
               y=dPCR_Orf1adel_agg$concentration * dPCR_Orf1adel_agg$frac,
               fill="dPCR ORF1a del"),
           stat="identity") + 
    xlab("date") + ylab("gc/ml") + guides(fill=FALSE) +
  theme_classic() +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("steelblue", "grey"),
  breaks = c("dPCR ORF1a del", "SARS-CoV-2"),
  labels = c("four", "six"))

plt3 <- ggplot() + 
  geom_bar(aes(x=clinical_models$Switzerland$ORF1adel$fit_3pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Switzerland$ORF1adel$fit_3pl$weights,
               fill="n"),
           stat="identity") + 
  geom_bar(aes(x=clinical_models$Switzerland$ORF1adel$fit_3pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Switzerland$ORF1adel$fit_3pl$weights * clinical_models$Switzerland$ORF1adel$fit_3pl$ydata,
               fill="clinical Orf1a del"),
           stat="identity") + 
    xlab("date") + ylab("samples") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("red2", "grey"),
  breaks = c("clinical Orf1a del", "n"),
  labels = c("four", "six"))

plt4 <- ggplot() + 
  geom_bar(aes(x=clinical_models$Switzerland$B117$fit_2pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Switzerland$B117$fit_2pl$weights,
               fill="n"),
           stat="identity") + 
  geom_bar(aes(x=clinical_models$Switzerland$B117$fit_2pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Switzerland$B117$fit_2pl$weights * clinical_models$Switzerland$B117$fit_2pl$ydata,
               fill="clinical B117"),
           stat="identity") + 
    xlab("date") + ylab("samples") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("orange", "grey"),
  breaks = c("clinical B117", "n"),
  labels = c("four", "six")) +
  theme(legend.position = "none")

plt_orf <- ggpubr::ggarrange(plt1 + xlab(""),
                             plt2 + xlab(""),
                             plt3 + xlab(""),
                             plt4, heights = c(2.5,1,1,1),
                    ncol = 1, align = "v", labels=c("B", "D", "F", "H"))
plt_orf

```

```{r}
pdf("fitplot_CH.pdf", height = 10, width = 12.5)
cowplot::plot_grid(plt_HV, plt_orf, ncol = 2)
dev.off()
```

## Plot for supplementary

### HV69-70del

```{r, fig.dim=c(7, 5)}
update_geom_defaults("point", list(size = 0.8))
points_alpha <- 0.8

plt1 <- ggplot() + 
  geom_point(aes(x=clinical_models$Zurich$HV6970del$fit_3pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Zurich$HV6970del$fit_3pl$ydata,
                color="clinical HV69-70del")) +
  geom_line(aes(x=clinical_models$Zurich$HV6970del$fit_3pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Zurich$HV6970del$fit_3pl$fitted,
                color="clinical HV69-70del")) + 
  geom_ribbon(aes(x=clinical_models$Zurich$HV6970del$fit_3pl$xdata + as.Date("2020-12-07"),
                  ymin=logist_confint.plt_fit(clinical_models$Zurich$HV6970del$fit_3pl)$lower,
                  ymax=logist_confint.plt_fit(clinical_models$Zurich$HV6970del$fit_3pl)$upper, fill="clinical HV69-70del"), alpha=0.2)  + 
  
  geom_point(aes(x=clinical_models$Zurich$B117$fit_2pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Zurich$B117$fit_2pl$ydata,
                color="clinical B.1.1.7")) +
  geom_line(aes(x=clinical_models$Zurich$B117$fit_2pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Zurich$B117$fit_2pl$fitted,
                color="clinical B.1.1.7")) + 
  geom_ribbon(aes(x=clinical_models$Zurich$B117$fit_2pl$xdata + as.Date("2020-12-07"),
                  ymin=logist_confint.plt_fit(clinical_models$Zurich$B117$fit_2pl)$lower,
                  ymax=logist_confint.plt_fit(clinical_models$Zurich$B117$fit_2pl)$upper, fill="clinical B.1.1.7"), alpha=0.2) + 
  
  geom_point(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_empirical_freqs, color="dPCR HV69-70del"),
             alpha = points_alpha) +
  geom_line(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_3PL$fitted, color="dPCR HV69-70del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_HV6970del$date),
                  ymin=logist_confint.plt_fit(dPCR_HV6970del_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_HV6970del_3PL)$upper, fill="dPCR HV69-70del"), alpha=0.2) + 
  
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) +
  theme_light() + 
  theme(legend.position="top") + 
  scale_colour_manual(
  values = c("steelblue", "red2", "orange"),
  breaks = c("dPCR HV69-70del", "clinical HV69-70del", "clinical B.1.1.7"),
  labels = c("wastewater HV69-70del", "clinical HV69-70del", "clinical B.1.1.7")
  ) + 
  scale_fill_manual(
  values = c("steelblue", "red2", "orange"),
  breaks = c("dPCR HV69-70del", "clinical HV69-70del", "clinical B.1.1.7"),
  labels = c("wastewater HV69-70del", "clinical HV69-70del", "clinical B.1.1.7")
  ) 

dPCR_HV6970del_agg <- aggregate(cbind(x0, x1, x2) ~ date + dayssince +Dilutionfactor,
                               data=dPCR_HV6970del, FUN=sum)
dPCR_HV6970del_agg <- dPCR_HV6970del_agg[,c("x0", "x1", "x2", "date", "dayssince", "Dilutionfactor")]
dPCR_HV6970del_agg$frac <- log((dPCR_HV6970del_agg[,1])/apply(dPCR_HV6970del_agg[,1:2], 1, sum)) /
  log(dPCR_HV6970del_agg[,1]/apply(dPCR_HV6970del_agg[,1:3], 1, sum))
dPCR_HV6970del_agg$concentration <- -log(dPCR_HV6970del_agg[,1]/apply(dPCR_HV6970del_agg[,1:3], 1, sum)) / 0.0005477004196028817 * 8 * dPCR_HV6970del_agg$Dilutionfactor
  


plt2 <- ggplot() + 
  geom_bar(aes(x=as.Date(dPCR_HV6970del_agg$date),
               y=dPCR_HV6970del_agg$concentration,
               fill="SARS-CoV-2"),
           stat="identity") + 
  geom_bar(aes(x=as.Date(dPCR_HV6970del_agg$date),
               y=dPCR_HV6970del_agg$concentration * dPCR_HV6970del_agg$frac,
               fill="dPCR HV6970 del"),
           stat="identity") + 
    xlab("date") + ylab("gc/ml") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("steelblue", "grey"),
  breaks = c("dPCR HV6970 del", "SARS-CoV-2"),
  labels = c("four", "six"))

plt3 <- ggplot() + 
  geom_bar(aes(x=clinical_models$Zurich$HV6970del$fit_3pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Zurich$HV6970del$fit_3pl$weights,
               fill="n"),
           stat="identity") + 
  geom_bar(aes(x=clinical_models$Zurich$HV6970del$fit_3pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Zurich$HV6970del$fit_3pl$weights * clinical_models$Zurich$HV6970del$fit_3pl$ydata,
               fill="clinical HV6970 del"),
           stat="identity") + 
    xlab("date") + ylab("samples") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("red2", "grey"),
  breaks = c("clinical HV6970 del", "n"),
  labels = c("four", "six"))

plt4 <- ggplot() + 
  geom_bar(aes(x=clinical_models$Zurich$B117$fit_2pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Zurich$B117$fit_2pl$weights,
               fill="n"),
           stat="identity") + 
  geom_bar(aes(x=clinical_models$Zurich$B117$fit_2pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Zurich$B117$fit_2pl$weights * clinical_models$Zurich$B117$fit_2pl$ydata,
               fill="clinical B117"),
           stat="identity") + 
    xlab("date") + ylab("samples") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("orange", "grey"),
  breaks = c("clinical B117", "n"),
  labels = c("four", "six")) +
  theme(legend.position = "none")

plt_HV <- ggpubr::ggarrange(plt1 + xlab(""),
                             plt2 + xlab(""),
                             plt3 + xlab(""),
                             plt4, heights = c(2.5,1,1,1),
                    ncol = 1, align = "v", labels = c("A","C","E","G"))

```

### ORF1a del

```{r, fig.dim=c(7, 5)}
points_alpha <- 0.8

plt1 <- ggplot() + 
  geom_point(aes(x=clinical_models$Zurich$ORF1adel$fit_3pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Zurich$ORF1adel$fit_3pl$ydata,
                color="clinical ORF1a del")) +
  geom_line(aes(x=clinical_models$Zurich$ORF1adel$fit_3pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Zurich$ORF1adel$fit_3pl$fitted,
                color="clinical ORF1a del")) + 
  geom_ribbon(aes(x=clinical_models$Zurich$ORF1adel$fit_3pl$xdata + as.Date("2020-12-07"),
                  ymin=logist_confint.plt_fit(clinical_models$Zurich$ORF1adel$fit_3pl)$lower,
                  ymax=logist_confint.plt_fit(clinical_models$Zurich$ORF1adel$fit_3pl)$upper, fill="clinical ORF1a del"), alpha=0.2)  +
  
    geom_point(aes(x=clinical_models$Zurich$ORF1adel$fit_2pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Zurich$ORF1adel$fit_2pl$ydata,
                color="clinical B.1.1.7")) +
  geom_line(aes(x=clinical_models$Zurich$ORF1adel$fit_2pl$xdata + as.Date("2020-12-07"),
                y=clinical_models$Zurich$ORF1adel$fit_2pl$fitted,
                color="clinical B.1.1.7")) + 
  geom_ribbon(aes(x=clinical_models$Zurich$ORF1adel$fit_2pl$xdata + as.Date("2020-12-07"),
                  ymin=logist_confint.plt_fit(clinical_models$Zurich$ORF1adel$fit_2pl)$lower,
                  ymax=logist_confint.plt_fit(clinical_models$Zurich$ORF1adel$fit_2pl)$upper, fill="clinical B.1.1.7"), alpha=0.2) + 
  
  geom_point(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_empirical_freqs, color="dPCR ORF1a del"),
             alpha = points_alpha) +
  geom_line(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_3PL$fitted, color="dPCR ORF1a del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_Orf1adel$date),
                  ymin=logist_confint.plt_fit(dPCR_Orf1a_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_Orf1a_3PL)$upper, fill="dPCR ORF1a del"), alpha=0.2) + 
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) +
  theme_light() + 
  theme(legend.position="top") + 
  scale_colour_manual(
  values = c("steelblue", "red2", "orange"),
  breaks = c("dPCR ORF1a del", "clinical ORF1a del", "clinical B.1.1.7"),
  labels = c("wastewater ORF1a del", "clinical ORF1a del", "clinical B.1.1.7")
  ) + 
  scale_fill_manual(
  values = c("steelblue", "red2", "orange"),
  breaks = c("dPCR ORF1a del", "clinical ORF1a del", "clinical B.1.1.7"),
  labels = c("wastewater ORF1a del", "clinical ORF1a del", "clinical B.1.1.7")
  )

dPCR_Orf1adel_agg <- aggregate(cbind(x0, x1, x2) ~ date + dayssince +Dilutionfactor,
                               data=dPCR_Orf1adel, FUN=sum)
dPCR_Orf1adel_agg <- dPCR_Orf1adel_agg[,c("x0", "x1", "x2", "date", "dayssince", "Dilutionfactor")]
dPCR_Orf1adel_agg$frac <- log((dPCR_Orf1adel_agg[,1])/apply(dPCR_Orf1adel_agg[,1:2], 1, sum)) /
  log(dPCR_Orf1adel_agg[,1]/apply(dPCR_Orf1adel_agg[,1:3], 1, sum))
dPCR_Orf1adel_agg$concentration <- -log(dPCR_Orf1adel_agg[,1]/apply(dPCR_Orf1adel_agg[,1:3], 1, sum)) / 0.0005477004196028817 * 8 * dPCR_Orf1adel_agg$Dilutionfactor
  
plt2 <- ggplot() + 
  geom_bar(aes(x=as.Date(dPCR_Orf1adel_agg$date),
               y=dPCR_Orf1adel_agg$concentration,
               # fill="SARS-CoV-2"
               ),
           stat="identity",
           fill="grey") + 
  geom_bar(aes(x=as.Date(dPCR_Orf1adel_agg$date),
               y=dPCR_Orf1adel_agg$concentration * dPCR_Orf1adel_agg$frac,
               fill="dPCR ORF1a del"),
           stat="identity") + 
    xlab("date") + ylab("gc/ml") + guides(fill=FALSE) +
  theme_classic() +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("steelblue", "grey"),
  breaks = c("dPCR ORF1a del", "SARS-CoV-2"),
  labels = c("four", "six"))

plt3 <- ggplot() + 
  geom_bar(aes(x=clinical_models$Zurich$ORF1adel$fit_3pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Zurich$ORF1adel$fit_3pl$weights,
               fill="n"),
           stat="identity") + 
  geom_bar(aes(x=clinical_models$Zurich$ORF1adel$fit_3pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Zurich$ORF1adel$fit_3pl$weights * clinical_models$Zurich$ORF1adel$fit_3pl$ydata,
               fill="clinical Orf1a del"),
           stat="identity") + 
    xlab("date") + ylab("samples") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("red2", "grey"),
  breaks = c("clinical Orf1a del", "n"),
  labels = c("four", "six"))

plt4 <- ggplot() + 
  geom_bar(aes(x=clinical_models$Zurich$B117$fit_2pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Zurich$B117$fit_2pl$weights,
               fill="n"),
           stat="identity") + 
  geom_bar(aes(x=clinical_models$Zurich$B117$fit_2pl$xdata + as.Date("2020-12-07"),
               y=clinical_models$Zurich$B117$fit_2pl$weights * clinical_models$Zurich$B117$fit_2pl$ydata,
               fill="clinical B117"),
           stat="identity") + 
    xlab("date") + ylab("samples") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("orange", "grey"),
  breaks = c("clinical B117", "n"),
  labels = c("four", "six")) +
  theme(legend.position = "none")


plt_orf <- ggpubr::ggarrange(plt1 + xlab(""),
                             plt2 + xlab(""),
                             plt3 + xlab(""),
                             plt4, heights = c(2.5,1,1,1),
                    ncol = 1, align = "v", labels=c("B", "D", "F", "H"))


```

```{r}
pdf("fitplot_ZH.pdf", height = 10, width = 12.5)
cowplot::plot_grid(plt_HV, plt_orf, ncol = 2)
dev.off()
```



## Plot all 

```{r}
points_alpha <- 0.8
plot_layers <- lapply(names(clinical_models), function(i, n1){
  out_j <- lapply(names(clinical_models[[i]]), function(j){
    out_k <- lapply(names(clinical_models[[i]][[j]]), function(k){
      mod = clinical_models[[i]][[j]][[k]]
      plot_points <- geom_point(aes(x=mod$xdata + as.Date("2020-12-07"), y=mod$ydata, color=paste(i,j,k)),
                 alpha = points_alpha) 
      plot_lines <- geom_line(aes(x=mod$xdata + as.Date("2020-12-07"), y=mod$fitted, color=paste(i,j,k)))
      plot_ribbon <- geom_ribbon(aes(x=mod$xdata + as.Date("2020-12-07"),
                  ymin=logist_confint.plt_fit(mod)$lower,
                  ymax=logist_confint.plt_fit(mod)$upper, fill=paste(i,j,k)), alpha=0.2)
      return(list(plot_points=plot_points, plot_lines=plot_lines, plot_ribbon=plot_ribbon))
      
    })
    names(out_k) <- names(clinical_models[[i]][[j]])
    return(out_k)
  })
  names(out_j) <- names(clinical_models[[i]])
  return(out_j)
})
names(plot_layers) <- names(clinical_models)


```

```{r, fig.dim=c(7, 5)}
ggplot() + 
  geom_point(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_empirical_freqs, color="dPCR ORF1a del"),
             alpha = points_alpha) +
  geom_line(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_3PL$fitted, color="dPCR ORF1a del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_Orf1adel$date),
                  ymin=logist_confint.plt_fit(dPCR_Orf1a_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_Orf1a_3PL)$upper, fill="dPCR ORF1a del"), alpha=0.2) +
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) + 
  
  plot_layers$Switzerland$ORF1adel$fit_3pl$plot_points +
  plot_layers$Switzerland$ORF1adel$fit_3pl$plot_lines +
  plot_layers$Switzerland$ORF1adel$fit_3pl$plot_ribbon  +

  plot_layers$Switzerland$B117$fit_2pl$plot_points +
  plot_layers$Switzerland$B117$fit_2pl$plot_lines +
  plot_layers$Switzerland$B117$fit_2pl$plot_ribbon  +
  # 
  # plot_layers$Zurich$ORF1adel$fit_3pl$plot_points +
  # plot_layers$Zurich$ORF1adel$fit_3pl$plot_lines +
  # plot_layers$Zurich$ORF1adel$fit_3pl$plot_ribbon  +
  # 
  # plot_layers$Zurich$B117$fit_2pl$plot_points +
  # plot_layers$Zurich$B117$fit_2pl$plot_lines +
  # plot_layers$Zurich$B117$fit_2pl$plot_ribbon  +
  
  theme_light() + 
  theme(legend.position="top")


ggplot() +
  geom_point(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_empirical_freqs, color="dPCR HV69-70del"),
             alpha = points_alpha) +
  geom_line(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_3PL$fitted, color="dPCR HV69-70del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_HV6970del$date),
                  ymin=logist_confint.plt_fit(dPCR_HV6970del_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_HV6970del_3PL)$upper, fill="dPCR HV69-70del"), alpha=0.2) +
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) + 
  
  plot_layers$Switzerland$HV6970del$fit_3pl$plot_points +
  plot_layers$Switzerland$HV6970del$fit_3pl$plot_lines +
  plot_layers$Switzerland$HV6970del$fit_3pl$plot_ribbon  +
  
  plot_layers$Switzerland$B117$fit_2pl$plot_points +
  plot_layers$Switzerland$B117$fit_2pl$plot_lines +
  plot_layers$Switzerland$B117$fit_2pl$plot_ribbon  +
  
  plot_layers$Zurich$HV6970del$fit_3pl$plot_points +
  plot_layers$Zurich$HV6970del$fit_3pl$plot_lines +
  plot_layers$Zurich$HV6970del$fit_3pl$plot_ribbon  +
  
  plot_layers$Zurich$B117$fit_2pl$plot_points +
  plot_layers$Zurich$B117$fit_2pl$plot_lines +
  plot_layers$Zurich$B117$fit_2pl$plot_ribbon  +
  
  theme_light() + 
  theme(legend.position="top")



```



## dPCR data overdispersion

### HV69-70 deletion

```{r, fig.dim=c(7, 5)}
n <- apply(dPCR_HV6970del[,1:3], 1, sum)

plt1 <- ggplot() + 
  geom_point(aes(x=n, y=log10(dPCR_HV6970del_3PL$overdispersion[[1]]), col="x1")) + 
  geom_point(aes(x=n, y=log10(dPCR_HV6970del_3PL$overdispersion[[2]]), col="x2")) 


for (i in 1:100){
    indxs <- sample(1:length(dPCR_HV6970del_3PL$overdispersion[[1]]), replace=T, prob=n)
    lo <- loess.smooth(n[order(n)][indxs], log10(dPCR_HV6970del_3PL$overdispersion[[1]])[order(n)][indxs])
    plt1 <- plt1 + 
      geom_line(aes_q(lo$x, lo$y, col="x1"), alpha=0.1)
    }
for (i in 1:100){
    indxs <- sample(1:length(dPCR_HV6970del_3PL$overdispersion[[2]]), replace=T, prob=n)
    lo <- loess.smooth(n[order(n)][indxs], log10(dPCR_HV6970del_3PL$overdispersion[[2]])[order(n)][indxs])
    plt1 <- plt1 + 
      geom_line(aes_q(lo$x, lo$y, col="x2"), alpha=0.1)
}
plt1 <- plt1 + 
  geom_line(aes(loess.smooth(n[order(n)], log10(dPCR_HV6970del_3PL$overdispersion[[1]])[order(n)])$x,
                loess.smooth(n[order(n)], log10(dPCR_HV6970del_3PL$overdispersion[[1]])[order(n)])$y,
                col="x1"))
plt1 <- plt1 + 
  geom_line(aes(loess.smooth(n[order(n)], log10(dPCR_HV6970del_3PL$overdispersion[[2]])[order(n)])$x,
                loess.smooth(n[order(n)], log10(dPCR_HV6970del_3PL$overdispersion[[2]])[order(n)])$y,
                col="x2"))

plt1 <- plt1 + 
  xlab("sample size") + ylab("log10 variance ratio") + 
  guides(fill=FALSE, colour=guide_legend(title="")) +
  theme_light() + 
  theme(legend.position="top")

plt1 <- plt1 + geom_text(aes(x=max(n) - diff(range(n))*0.2,
                  y=max(log10(unlist(dPCR_HV6970del_3PL$overdispersion))) - diff(range(log10(unlist(dPCR_HV6970del_3PL$overdispersion))))*0.95,
                  label=paste("infl.factor=", round(dPCR_HV6970del_3PL$infl_factor,2), sep="")))

hv6970overdisp <- plt1
hv6970overdisp

```


### ORF1a deletion

```{r, fig.dim=c(7, 5)}
n <- apply(dPCR_Orf1adel[,1:3], 1, sum)

plt1 <- ggplot() + 
  geom_point(aes(x=n, y=log10(dPCR_Orf1a_2PL$overdispersion[[1]]), col="x1")) + 
  geom_point(aes(x=n, y=log10(dPCR_Orf1a_2PL$overdispersion[[2]]), col="x2")) 


for (i in 1:100){
    indxs <- sample(1:length(dPCR_Orf1a_2PL$overdispersion[[1]]), replace=T, prob=n)
    lo <- loess.smooth(n[order(n)][indxs], log10(dPCR_Orf1a_2PL$overdispersion[[1]])[order(n)][indxs])
    plt1 <- plt1 + 
      geom_line(aes_q(lo$x, lo$y, col="x1"), alpha=0.1)
    }
for (i in 1:100){
    indxs <- sample(1:length(dPCR_Orf1a_2PL$overdispersion[[2]]), replace=T, prob=n)
    lo <- loess.smooth(n[order(n)][indxs], log10(dPCR_Orf1a_2PL$overdispersion[[2]])[order(n)][indxs])
    plt1 <- plt1 + 
      geom_line(aes_q(lo$x, lo$y, col="x2"), alpha=0.1)
}
plt1 <- plt1 + 
  geom_line(aes(loess.smooth(n[order(n)], log10(dPCR_Orf1a_2PL$overdispersion[[1]])[order(n)])$x,
                loess.smooth(n[order(n)], log10(dPCR_Orf1a_2PL$overdispersion[[1]])[order(n)])$y,
                col="x1"))
plt1 <- plt1 + 
  geom_line(aes(loess.smooth(n[order(n)], log10(dPCR_Orf1a_2PL$overdispersion[[2]])[order(n)])$x,
                loess.smooth(n[order(n)], log10(dPCR_Orf1a_2PL$overdispersion[[2]])[order(n)])$y,
                col="x2"))

plt1 <- plt1 + 
  xlab("sample size") + ylab("log10 variance ratio") + 
  guides(fill=FALSE, colour=guide_legend(title="")) +
  theme_light() + 
  theme(legend.position="top")

plt1 <- plt1 + geom_text(aes(x=max(n) - diff(range(n))*0.2,
                  y=max(log10(unlist(dPCR_Orf1a_2PL$overdispersion))) - diff(range(log10(unlist(dPCR_Orf1a_2PL$overdispersion))))*0.95,
                  label=paste("infl.factor=", round(dPCR_Orf1a_2PL$infl_factor,2), sep="")))

orf1aoverdisp <- plt1


```

### Clinical data

```{r}

overdisp_plot <- function(model){
  n <- model$weights
  overdisp <- model$overdispersion
  plt1 <- ggplot() + 
    geom_point(aes(x=n, y=log10(overdisp))) 
  
  
  for (i in 1:100){
      indxs <- sample(1:length(overdisp), replace=T, prob=n)
      lo <- loess.smooth(n[order(n)][indxs], log10(overdisp)[order(n)][indxs])
      plt1 <- plt1 + 
        geom_line(aes_q(lo$x, lo$y), alpha=0.1)
      }
  
  plt1 <- plt1 + 
    geom_line(aes(loess.smooth(n[order(n)], log10(overdisp)[order(n)])$x,
                  loess.smooth(n[order(n)], log10(overdisp)[order(n)])$y))
  
  
  plt1 <- plt1 + 
    xlab("sample size") + ylab("log10 variance ratio") + 
    guides(fill=FALSE, colour=guide_legend(title="")) +
    theme_light() + 
    theme(legend.position="top")
  
  
  plt1 <- plt1 + 
    geom_text(aes(x=max(n) - diff(range(n))*0.2,
                  y=max(log10(overdisp)) - diff(range(log10(overdisp)))*0.05,
                  label=paste("infl.factor=", round(model$infl_factor,2), sep="")))
  return(plt1)
}

pdf("overdisp_plot.pdf", height = 10, width = 12.5)
ggpubr::ggarrange(
  hv6970overdisp,
  orf1aoverdisp,
  overdisp_plot(clinical_models$Switzerland$HV6970del$fit_3pl),
  overdisp_plot(clinical_models$Zurich$HV6970del$fit_3pl),
  overdisp_plot(clinical_models$Switzerland$ORF1adel$fit_3pl),
  overdisp_plot(clinical_models$Zurich$ORF1adel$fit_3pl),
  overdisp_plot(clinical_models$Switzerland$B117$fit_2pl),
  overdisp_plot(clinical_models$Zurich$B117$fit_2pl),
  ncol = 2, nrow = 4,
  align = "v", 
  labels=LETTERS[1:8])
dev.off()
```

