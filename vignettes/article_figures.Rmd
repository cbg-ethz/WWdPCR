---
title: "article_figures"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{article_figures}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(WWdPCR)
library(ggplot2)
```

# Load and check data

Data is stored as .rda and has been loaded when attaching the package.

```{r}
str(dPCR_HV6970del)
str(dPCR_Orf1adel)
str(clinical_HV6970del)
str(clinical_ORF1adel)
```

# Fit models on dPCR WWTP data

## Fit 3PL on wastewater data

### Fit on HV69-70del

```{r}
dPCR_HV6970del_3PL <- fit_pl(dPCR_HV6970del[,1:3], dPCR_HV6970del$dayssince,
                             likelihood = loglik_trinom_prof,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
knitr::kable(confint(dPCR_HV6970del_3PL))
```

### Fit on Orf1a

```{r}
dPCR_Orf1a_3PL <- fit_pl(dPCR_Orf1adel[,1:3], dPCR_Orf1adel$dayssince,
                             likelihood = loglik_trinom_prof,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
knitr::kable(confint(dPCR_Orf1a_3PL))
```

## Fit 2PL on wastewater data

### Fit on HV69-70del

```{r}
dPCR_HV6970del_2PL <- fit_pl(dPCR_HV6970del[,1:3], dPCR_HV6970del$dayssince,
                             likelihood = loglik_trinom_prof,
                             fitfun = pl2model,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10),
                             lower=c(0, -Inf), upper=c(1, Inf))
knitr::kable(confint(dPCR_HV6970del_2PL))
```

### Fit on Orf1a

```{r}
dPCR_Orf1a_2PL <- fit_pl(dPCR_Orf1adel[,1:3], dPCR_Orf1adel$dayssince,
                             likelihood = loglik_trinom_prof,
                             fitfun = pl2model,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10),
                             lower=c(0, -Inf), upper=c(1, Inf))
knitr::kable(confint(dPCR_Orf1a_2PL))
```

## Quasi likelihood ratio tests

Using largest inflation factor 

```{r}
# compute quasi log-likelihood ratio, with inflation factor from 2PL (more conservative)
dPCR_HV6970_llr <- -2*((-1*dPCR_HV6970del_3PL$likelihood/dPCR_HV6970del_2PL$infl_factor) - (-1*dPCR_HV6970del_3PL$likelihood/dPCR_HV6970del_3PL$infl_factor))
# chisquare test of the log-likelihood ratio
knitr::kable(data.frame("2logLr:"=dPCR_HV6970_llr, "p-val:"=formatC(1-pchisq(dPCR_HV6970_llr, 1), format = "e", digits = 2)))
```

```{r}
# compute quasi log-likelihood ratio, with inflation factor from 2PL (more conservative)
dPCR_Orf1a_llr <- -2*((-1*dPCR_Orf1a_3PL$likelihood/dPCR_Orf1a_2PL$infl_factor) - (-1*dPCR_Orf1a_2PL$likelihood/dPCR_Orf1a_2PL$infl_factor))
# chisquare test of the log-likelihood ratio
knitr::kable(data.frame("2logLr:"=dPCR_Orf1a_llr, "p-val:"=formatC(1-pchisq(dPCR_Orf1a_llr, 1), format = "e", digits = 2)))
```



# Fit models on clinical data

## Fit 3PL on clinical data

### Fit on HV69-70del

```{r}
clinical_HV6970del <- clinical_HV6970del[(as.Date(clinical_HV6970del$date) >= as.Date("2020-12-07")) & 
                                           (as.Date(clinical_HV6970del$date) <= as.Date("2021-03-26")), ]

clinical_HV6970del_3PL <- fit_pl(clinical_HV6970del$HV69.70del/clinical_HV6970del$sequenced,
                             as.numeric(as.Date(clinical_HV6970del$date)-as.Date("2020-12-07")),
                             clinical_HV6970del$sequenced,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
knitr::kable(confint(clinical_HV6970del_3PL))
```


### Fit on Orf1a

```{r}
clinical_ORF1adel <- clinical_ORF1adel[(as.Date(clinical_ORF1adel$date) >= as.Date("2020-12-07")) & 
                                           (as.Date(clinical_ORF1adel$date) <= as.Date("2021-03-26")), ]
clinical_ORF1a_3PL <- fit_pl(clinical_ORF1adel$ORF1adel/clinical_ORF1adel$sequenced,
                             as.numeric(as.Date(clinical_ORF1adel$date)-as.Date("2020-12-07")),
                             clinical_ORF1adel$sequenced,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
knitr::kable(confint(clinical_ORF1a_3PL))
```

## Fit 2PL on clinical data

### Fit on HV69-70del

```{r}
clinical_HV6970del_2PL <- fit_pl(clinical_HV6970del$HV69.70del/clinical_HV6970del$sequenced,
                             as.numeric(as.Date(clinical_HV6970del$date)-as.Date("2020-12-07")),
                             clinical_HV6970del$sequenced,
                             fitfun = pl2model,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10),
                             lower=c(0, -Inf), upper=c(1, Inf))
knitr::kable(confint(clinical_HV6970del_2PL))
```

### Fit on Orf1a

```{r}
clinical_ORF1a_2PL <- fit_pl(clinical_ORF1adel$ORF1adel/clinical_ORF1adel$sequenced,
                             as.numeric(as.Date(clinical_ORF1adel$date)-as.Date("2020-12-07")),
                             clinical_ORF1adel$sequenced,
                             fitfun = pl2model,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10),
                             lower=c(0, -Inf), upper=c(1, Inf))
knitr::kable(confint(clinical_ORF1a_2PL))
```


### Fit all

```{r}
clinical_data_tot <- aggregate(. ~ date, data=clinical_data, sum)
clinical_data_tot <- clinical_data_tot[(as.Date(clinical_data_tot$date) >= as.Date("2020-12-07")) & 
                                           (as.Date(clinical_data_tot$date) <= as.Date("2021-03-26")), ]

clinical_data_ZH <- clinical_data[clinical_data$division == "Zurich",]
clinical_data_ZH <- clinical_data_ZH[(as.Date(clinical_data_ZH$date) >= as.Date("2020-12-07")) & 
                                           (as.Date(clinical_data_ZH$date) <= as.Date("2021-03-26")), ]

clinical_models <- list()
clinical_models$Switzerland <- lapply(c("HV6970del", "ORF1adel", "B117"), function(i){
  fit_3pl <- fit_pl(clinical_data_tot[, i] /clinical_data_tot$Tot,
                             as.numeric(as.Date(clinical_data_tot$date)-as.Date("2020-12-07")),
                             clinical_data_tot$Tot,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
  
  fit_2pl <- fit_pl(clinical_data_tot[, i]/clinical_data_tot$Tot,
                             as.numeric(as.Date(clinical_data_tot$date)-as.Date("2020-12-07")),
                             clinical_data_tot$Tot,
                             fitfun = pl2model,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10),
                             lower=c(0, -Inf), upper=c(1, Inf))
  out <- list(fit_3pl = fit_3pl, fit_2pl = fit_2pl)
  out
})
names(clinical_models$Switzerland) <- c("HV6970del", "ORF1adel", "B117")

clinical_models$Zurich <- lapply(c("HV6970del", "ORF1adel", "B117"), function(i){
  fit_3pl <- fit_pl(clinical_data_ZH[, i] /clinical_data_ZH$Tot,
                             as.numeric(as.Date(clinical_data_ZH$date)-as.Date("2020-12-07")),
                             clinical_data_ZH$Tot,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10, "c"=0.01),
                             lower=c(0, -Inf, 0), upper=c(1, Inf, 1))
  
  fit_2pl <- fit_pl(clinical_data_ZH[, i]/clinical_data_ZH$Tot,
                             as.numeric(as.Date(clinical_data_ZH$date)-as.Date("2020-12-07")),
                             clinical_data_ZH$Tot,
                             fitfun = pl2model,
                             likelihood = loglik_binom_n,
                             quasi=TRUE,
                             starting_values = c("a"=0.05, "b"=-10),
                             lower=c(0, -Inf), upper=c(1, Inf))
  out <- list(fit_3pl = fit_3pl, fit_2pl = fit_2pl)
  out
})
names(clinical_models$Zurich) <- c("HV6970del", "ORF1adel", "B117")

coef(clinical_models$Switzerland$HV6970del$fit_3pl)

lapply(clinical_models, function(i){
  lapply(i, function(j){
    lapply(j, function(k){
     knitr::kable(confint(k))
    })
  })
})


```

### Quasi log-likelihood ratio tests

```{r}
lapply(clinical_models, function(i){
  lapply(i, function(j){
    llr <- -2*((-1*j$fit_3pl$likelihood / j$fit_2pl$infl_factor) - (-1*j$fit_2pl$likelihood/j$fit_2pl$infl_factor))
    knitr::kable(data.frame("2logLr:"=llr, "p-val:"=formatC(1-pchisq(llr, 1), format = "e", digits = 2)))
  })
})

```

## Quasi likelihood ratio tests

Using largest inflation factor 

```{r}
# compute quasi log-likelihood ratio, with inflation factor from 2PL (more conservative)
clinical_HV6970_llr <- -2*((-1*clinical_HV6970del_3PL$likelihood/clinical_HV6970del_2PL$infl_factor) - (-1*clinical_HV6970del_2PL$likelihood/clinical_HV6970del_2PL$infl_factor))
# chisquare test of the log-likelihood ratio
knitr::kable(data.frame("2logLr:"=clinical_HV6970_llr, "p-val:"=formatC(1-pchisq(clinical_HV6970_llr, 1), format = "e", digits = 2)))
```

```{r}
# compute quasi log-likelihood ratio, with inflation factor from 2PL (more conservative)
clinical_ORF1a_llr <- -2*((-1*clinical_ORF1a_3PL$likelihood/clinical_ORF1a_2PL$infl_factor) - (-1*clinical_ORF1a_2PL$likelihood/clinical_ORF1a_2PL$infl_factor))
# chisquare test of the log-likelihood ratio
knitr::kable(data.frame("2logLr:"=clinical_ORF1a_llr, "p-val:"=formatC(1-pchisq(clinical_ORF1a_llr, 1), format = "e", digits = 2)))
```





# Plots

```{r, fig.dim=c(7, 5)}
dPCR_HV6970del_empirical_freqs <- log((dPCR_HV6970del[,1]+dPCR_HV6970del[,2])/apply(dPCR_HV6970del[,1:3], 1, sum)) / log(dPCR_HV6970del[,1]/apply(dPCR_HV6970del[,1:3], 1, sum))

dPCR_Orf1a_empirical_freqs <- log((dPCR_Orf1adel[,1]+dPCR_Orf1adel[,2])/apply(dPCR_Orf1adel[,1:3], 1, sum)) / log(dPCR_Orf1adel[,1]/apply(dPCR_Orf1adel[,1:3], 1, sum))

ggplot() + 
  geom_point(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_empirical_freqs, color="dPCR HV69-70del")) +
  geom_line(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_3PL$fitted, color="dPCR HV69-70del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_HV6970del$date),
                  ymin=logist_confint.plt_fit(dPCR_HV6970del_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_HV6970del_3PL)$upper, fill="dPCR HV69-70del"), alpha=0.2) + 

  
  geom_point(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_empirical_freqs, color="dPCR Orf1a")) + 
  geom_line(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_2PL$fitted, color="dPCR Orf1a")) + 
  geom_ribbon(aes(x=as.Date(dPCR_Orf1adel$date),
                  ymin=logist_confint.plt_fit(dPCR_Orf1a_2PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_Orf1a_2PL)$upper, fill="dPCR Orf1a"), alpha=0.2) + 
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) +
  theme_light() + 
  theme(legend.position="top")


```

## By mutations

### HV69-70del

```{r, fig.dim=c(7, 5)}
points_alpha <- 0.8

plt1 <- ggplot() + 
  geom_point(aes(x=as.Date(clinical_HV6970del$date), y=clinical_HV6970del$HV69.70del/clinical_HV6970del$sequenced,
                 color="clinical HV69-70del"),
             alpha = points_alpha) + 
  geom_line(aes(x=as.Date(clinical_HV6970del$date), y=clinical_HV6970del_3PL$fitted, color="clinical HV69-70del")) + 
  geom_ribbon(aes(x=as.Date(clinical_HV6970del$date),
                  ymin=logist_confint.plt_fit(clinical_HV6970del_3PL)$lower,
                  ymax=logist_confint.plt_fit(clinical_HV6970del_3PL)$upper, fill="clinical HV69-70del"), alpha=0.2) + 
  
  geom_point(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_empirical_freqs, color="dPCR HV69-70del"),
             alpha = points_alpha) +
  geom_line(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_3PL$fitted, color="dPCR HV69-70del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_HV6970del$date),
                  ymin=logist_confint.plt_fit(dPCR_HV6970del_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_HV6970del_3PL)$upper, fill="dPCR HV69-70del"), alpha=0.2) + 
  
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) +
  theme_light() + 
  theme(legend.position="top") + 
  scale_colour_manual(
  values = c("steelblue", "red2"),
  breaks = c("dPCR HV69-70del", "clinical HV69-70del"),
  labels = c("dPCR HV69-70del", "clinical HV69-70del")
  ) + 
  scale_fill_manual(
  values = c("steelblue", "red2"),
  breaks = c("dPCR HV69-70del", "clinical HV69-70del"),
  labels = c("dPCR HV69-70del", "clinical HV69-70del")
  )

plt2 <- ggplot() + 
  geom_bar(aes(x=as.Date(dPCR_HV6970del$date),
               y=-log(dPCR_HV6970del[,1]/apply(dPCR_HV6970del[,1:3], 1, sum)) / 0.0005477004196028817 * 8,
               fill="SARS-CoV-2"),
           stat="identity") + 
  geom_bar(aes(x=as.Date(dPCR_HV6970del$date),
               y=dPCR_HV6970del_empirical_freqs*-log(dPCR_HV6970del[,1]/apply(dPCR_HV6970del[,1:3], 1, sum)) / 0.0005477004196028817 * 8 ,
               fill="dPCR HV6970 del"),
           stat="identity") + 
    xlab("date") + ylab("gc/ml") +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("steelblue", "grey"),
  breaks = c("dPCR HV6970 del", "SARS-CoV-2"),
  labels = c("four", "six"))

plt_HV <- cowplot::plot_grid(plt1, plt2, ncol=1, align = "hv", axis = "rlbt", rel_heights = c(1.5,1))
plt_HV

```

### ORF1a del

```{r, fig.dim=c(7, 5)}
points_alpha <- 0.8

plt1 <- ggplot() + 
  geom_point(aes(x=as.Date(clinical_ORF1adel$date), y=clinical_ORF1adel$ORF1adel/clinical_ORF1adel$sequenced,
                 color="clinical ORF1a del"),
             alpha = points_alpha) + 
  geom_line(aes(x=as.Date(clinical_ORF1adel$date), y=clinical_ORF1a_3PL$fitted, color="clinical ORF1a del")) + 
  geom_ribbon(aes(x=as.Date(clinical_ORF1adel$date),
                  ymin=logist_confint.plt_fit(clinical_ORF1a_3PL)$lower,
                  ymax=logist_confint.plt_fit(clinical_ORF1a_3PL)$upper, fill="clinical ORF1a del"), alpha=0.2) + 
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) +
  
  geom_point(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_empirical_freqs, color="dPCR ORF1a del"),
             alpha = points_alpha) +
  geom_line(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_3PL$fitted, color="dPCR ORF1a del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_Orf1adel$date),
                  ymin=logist_confint.plt_fit(dPCR_Orf1a_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_Orf1a_3PL)$upper, fill="dPCR ORF1a del"), alpha=0.2) + 

  theme_light() + 
  theme(legend.position="top") + 
  scale_colour_manual(
  values = c("steelblue", "red2"),
  breaks = c("dPCR ORF1a del", "clinical ORF1a del"),
  labels = c("dPCR ORF1a del", "clinical ORF1a del")
  ) + 
  scale_fill_manual(
  values = c("steelblue", "red2"),
  breaks = c("dPCR ORF1a del", "clinical ORF1a del"),
  labels = c("dPCR ORF1a del", "clinical ORF1a del")
  )


plt2 <- ggplot() + 
  geom_bar(aes(x=as.Date(dPCR_Orf1adel$date),
               y=-log(dPCR_Orf1adel[,1]/apply(dPCR_Orf1adel[,1:3], 1, sum)) / 0.0005477004196028817 * 8 
               # fill="SARS-CoV-2"
               ),
           stat="identity",
           fill="grey") + 
  geom_bar(aes(x=as.Date(dPCR_Orf1adel$date),
               y=dPCR_Orf1a_empirical_freqs*-log(dPCR_Orf1adel[,1]/apply(dPCR_Orf1adel[,1:3], 1, sum)) / 0.0005477004196028817 * 8,
               fill="dPCR ORF1a del"),
           stat="identity") + 
    xlab("date") + ylab("gc/ml") + guides(fill=FALSE) +
  theme_classic() +
  guides(fill=FALSE) +
  theme_classic() + scale_fill_manual(
  values = c("steelblue", "grey"),
  breaks = c("dPCR ORF1a del", "SARS-CoV-2"),
  labels = c("four", "six"))

plt_orf <- cowplot::plot_grid(plt1, plt2, ncol=1, align = "hv", axis = "rlbt", rel_heights = c(1.5,1))
plt_orf

```

## Plot all

```{r}
points_alpha <- 0.8
plot_layers <- lapply(names(clinical_models), function(i, n1){
  out_j <- lapply(names(clinical_models[[i]]), function(j){
    out_k <- lapply(names(clinical_models[[i]][[j]]), function(k){
      mod = clinical_models[[i]][[j]][[k]]
      plot_points <- geom_point(aes(x=mod$xdata + as.Date("2020-12-07"), y=mod$ydata, color=paste(i,j,k)),
                 alpha = points_alpha) 
      plot_lines <- geom_line(aes(x=mod$xdata + as.Date("2020-12-07"), y=mod$fitted, color=paste(i,j,k)))
      plot_ribbon <- geom_ribbon(aes(x=mod$xdata + as.Date("2020-12-07"),
                  ymin=logist_confint.plt_fit(mod)$lower,
                  ymax=logist_confint.plt_fit(mod)$upper, fill=paste(i,j,k)), alpha=0.2)
      return(list(plot_points=plot_points, plot_lines=plot_lines, plot_ribbon=plot_ribbon))
      
    })
    names(out_k) <- names(clinical_models[[i]][[j]])
    return(out_k)
  })
  names(out_j) <- names(clinical_models[[i]])
  return(out_j)
})
names(plot_layers) <- names(clinical_models)


```

```{r, fig.dim=c(7, 5)}
ggplot() + 
  geom_point(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_empirical_freqs, color="dPCR ORF1a del"),
             alpha = points_alpha) +
  geom_line(aes(x=as.Date(dPCR_Orf1adel$date), y=dPCR_Orf1a_3PL$fitted, color="dPCR ORF1a del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_Orf1adel$date),
                  ymin=logist_confint.plt_fit(dPCR_Orf1a_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_Orf1a_3PL)$upper, fill="dPCR ORF1a del"), alpha=0.2) +
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) + 
  
  plot_layers$Switzerland$ORF1adel$fit_3pl$plot_points +
  plot_layers$Switzerland$ORF1adel$fit_3pl$plot_lines +
  plot_layers$Switzerland$ORF1adel$fit_3pl$plot_ribbon  +

  plot_layers$Switzerland$B117$fit_2pl$plot_points +
  plot_layers$Switzerland$B117$fit_2pl$plot_lines +
  plot_layers$Switzerland$B117$fit_2pl$plot_ribbon  +
  # 
  # plot_layers$Zurich$ORF1adel$fit_3pl$plot_points +
  # plot_layers$Zurich$ORF1adel$fit_3pl$plot_lines +
  # plot_layers$Zurich$ORF1adel$fit_3pl$plot_ribbon  +
  # 
  # plot_layers$Zurich$B117$fit_2pl$plot_points +
  # plot_layers$Zurich$B117$fit_2pl$plot_lines +
  # plot_layers$Zurich$B117$fit_2pl$plot_ribbon  +
  
  theme_light() + 
  theme(legend.position="top")


ggplot() +
  geom_point(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_empirical_freqs, color="dPCR HV69-70del"),
             alpha = points_alpha) +
  geom_line(aes(x=as.Date(dPCR_HV6970del$date), y=dPCR_HV6970del_3PL$fitted, color="dPCR HV69-70del")) + 
  geom_ribbon(aes(x=as.Date(dPCR_HV6970del$date),
                  ymin=logist_confint.plt_fit(dPCR_HV6970del_3PL)$lower,
                  ymax=logist_confint.plt_fit(dPCR_HV6970del_3PL)$upper, fill="dPCR HV69-70del"), alpha=0.2) +
  xlab("date") + ylab("deletion frequency") + guides(fill=FALSE, colour=guide_legend(title="")) + 
  
  plot_layers$Switzerland$HV6970del$fit_3pl$plot_points +
  plot_layers$Switzerland$HV6970del$fit_3pl$plot_lines +
  plot_layers$Switzerland$HV6970del$fit_3pl$plot_ribbon  +
  
  plot_layers$Switzerland$B117$fit_2pl$plot_points +
  plot_layers$Switzerland$B117$fit_2pl$plot_lines +
  plot_layers$Switzerland$B117$fit_2pl$plot_ribbon  +
  
  plot_layers$Zurich$HV6970del$fit_3pl$plot_points +
  plot_layers$Zurich$HV6970del$fit_3pl$plot_lines +
  plot_layers$Zurich$HV6970del$fit_3pl$plot_ribbon  +
  
  plot_layers$Zurich$B117$fit_2pl$plot_points +
  plot_layers$Zurich$B117$fit_2pl$plot_lines +
  plot_layers$Zurich$B117$fit_2pl$plot_ribbon  +
  
  theme_light() + 
  theme(legend.position="top")



```



## dPCR data overdispersion

### HV69-70 deletion

```{r, fig.dim=c(7, 5)}
n <- apply(dPCR_HV6970del[,1:3], 1, sum)

plt1 <- ggplot() + 
  geom_point(aes(x=n, y=log10(dPCR_HV6970del_3PL$overdispersion[[1]]), col="x1")) + 
  geom_point(aes(x=n, y=log10(dPCR_HV6970del_3PL$overdispersion[[2]]), col="x2")) 


for (i in 1:100){
    indxs <- sample(1:length(dPCR_HV6970del_3PL$overdispersion[[1]]), replace=T, prob=n)
    lo <- loess.smooth(n[order(n)][indxs], log10(dPCR_HV6970del_3PL$overdispersion[[1]])[order(n)][indxs])
    plt1 <- plt1 + 
      geom_line(aes_q(lo$x, lo$y, col="x1"), alpha=0.1)
    }
for (i in 1:100){
    indxs <- sample(1:length(dPCR_HV6970del_3PL$overdispersion[[2]]), replace=T, prob=n)
    lo <- loess.smooth(n[order(n)][indxs], log10(dPCR_HV6970del_3PL$overdispersion[[2]])[order(n)][indxs])
    plt1 <- plt1 + 
      geom_line(aes_q(lo$x, lo$y, col="x2"), alpha=0.1)
}
plt1 <- plt1 + 
  geom_line(aes(loess.smooth(n[order(n)], log10(dPCR_HV6970del_3PL$overdispersion[[1]])[order(n)])$x,
                loess.smooth(n[order(n)], log10(dPCR_HV6970del_3PL$overdispersion[[1]])[order(n)])$y,
                col="x1"))
plt1 <- plt1 + 
  geom_line(aes(loess.smooth(n[order(n)], log10(dPCR_HV6970del_3PL$overdispersion[[2]])[order(n)])$x,
                loess.smooth(n[order(n)], log10(dPCR_HV6970del_3PL$overdispersion[[2]])[order(n)])$y,
                col="x2"))

plt1 <- plt1 + 
  xlab("sample size") + ylab("log10 variance ratio") + 
  guides(fill=FALSE, colour=guide_legend(title="")) +
  theme_light() + 
  theme(legend.position="top")

plt1


```


### ORF1a deletion

```{r, fig.dim=c(7, 5)}
n <- apply(dPCR_Orf1adel[,1:3], 1, sum)

plt1 <- ggplot() + 
  geom_point(aes(x=n, y=log10(dPCR_Orf1a_2PL$overdispersion[[1]]), col="x1")) + 
  geom_point(aes(x=n, y=log10(dPCR_Orf1a_2PL$overdispersion[[2]]), col="x2")) 


for (i in 1:100){
    indxs <- sample(1:length(dPCR_Orf1a_2PL$overdispersion[[1]]), replace=T, prob=n)
    lo <- loess.smooth(n[order(n)][indxs], log10(dPCR_Orf1a_2PL$overdispersion[[1]])[order(n)][indxs])
    plt1 <- plt1 + 
      geom_line(aes_q(lo$x, lo$y, col="x1"), alpha=0.1)
    }
for (i in 1:100){
    indxs <- sample(1:length(dPCR_Orf1a_2PL$overdispersion[[2]]), replace=T, prob=n)
    lo <- loess.smooth(n[order(n)][indxs], log10(dPCR_Orf1a_2PL$overdispersion[[2]])[order(n)][indxs])
    plt1 <- plt1 + 
      geom_line(aes_q(lo$x, lo$y, col="x2"), alpha=0.1)
}
plt1 <- plt1 + 
  geom_line(aes(loess.smooth(n[order(n)], log10(dPCR_Orf1a_2PL$overdispersion[[1]])[order(n)])$x,
                loess.smooth(n[order(n)], log10(dPCR_Orf1a_2PL$overdispersion[[1]])[order(n)])$y,
                col="x1"))
plt1 <- plt1 + 
  geom_line(aes(loess.smooth(n[order(n)], log10(dPCR_Orf1a_2PL$overdispersion[[2]])[order(n)])$x,
                loess.smooth(n[order(n)], log10(dPCR_Orf1a_2PL$overdispersion[[2]])[order(n)])$y,
                col="x2"))

plt1 <- plt1 + 
  xlab("sample size") + ylab("log10 variance ratio") + 
  guides(fill=FALSE, colour=guide_legend(title="")) +
  theme_light() + 
  theme(legend.position="top")

plt1


```

